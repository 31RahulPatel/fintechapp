# FintechOps - Docker Compose
# Development configuration with all services

version: '3.8'

services:
  # ============================================
  # DATABASES
  # ============================================
  mongodb:
    image: mongo:7.0
    container_name: fintechops-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"
    networks:
      - fintechops-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 5

  postgres:
    image: postgres:16-alpine
    container_name: fintechops-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fintechops}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password123}
      POSTGRES_DB: ${POSTGRES_DB:-fintechops}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - fintechops-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fintechops}"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: fintechops-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - fintechops-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # MICROSERVICES
  # ============================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: fintechops-api-gateway
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3000
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USER_SERVICE_URL=http://user-service:3002
      - MARKET_SERVICE_URL=http://market-service:3004
      - NEWS_SERVICE_URL=http://news-service:3005
      - BLOG_SERVICE_URL=http://blog-service:3006
      - CALCULATOR_SERVICE_URL=http://calculator-service:3003
      - CHATBOT_SERVICE_URL=http://chatbot-service:3007
      - EMAIL_SERVICE_URL=http://email-service:3008
      - ADMIN_SERVICE_URL=http://admin-service:3009
    ports:
      - "3000:3000"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fintechops-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: fintechops-auth-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3001
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-your-refresh-secret-key}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_COGNITO_USER_POOL_ID=${AWS_COGNITO_USER_POOL_ID}
      - AWS_COGNITO_CLIENT_ID=${AWS_COGNITO_CLIENT_ID}
      - AWS_COGNITO_CLIENT_SECRET=${AWS_COGNITO_CLIENT_SECRET}
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER:-fintechops}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password123}
      - POSTGRES_DB=${POSTGRES_DB:-fintechops}
    ports:
      - "3001:3001"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fintechops-network

  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: fintechops-user-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3002
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - POSTGRES_URI=postgres://fintechops:password123@postgres:5432/fintechops
    ports:
      - "3002:3002"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - fintechops-network

  calculator-service:
    build:
      context: ./services/calculator-service
      dockerfile: Dockerfile
    container_name: fintechops-calculator-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3003
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - REDIS_URL=redis://redis:6379
    ports:
      - "3003:3003"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fintechops-network

  market-service:
    build:
      context: ./services/market-service
      dockerfile: Dockerfile
    container_name: fintechops-market-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3004
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - REDIS_URL=redis://redis:6379
    ports:
      - "3004:3004"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fintechops-network

  news-service:
    build:
      context: ./services/news-service
      dockerfile: Dockerfile
    container_name: fintechops-news-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3005
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
    ports:
      - "3005:3005"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fintechops-network

  blog-service:
    build:
      context: ./services/blog-service
      dockerfile: Dockerfile
    container_name: fintechops-blog-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3006
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
    ports:
      - "3006:3006"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fintechops-network

  chatbot-service:
    build:
      context: ./services/chatbot-service
      dockerfile: Dockerfile
    container_name: fintechops-chatbot-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3007
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - REDIS_URL=redis://redis:6379
    ports:
      - "3007:3007"
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fintechops-network

  email-service:
    build:
      context: ./services/email-service
      dockerfile: Dockerfile
    container_name: fintechops-email-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3008
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_SES_FROM_EMAIL=${AWS_SES_FROM_EMAIL}
      # Gmail SMTP for local real email sending
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USER=${SMTP_USER:-patelrahul3105@gmail.com}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM:-patelrahul3105@gmail.com}
    ports:
      - "3008:3008"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fintechops-network

  admin-service:
    build:
      context: ./services/admin-service
      dockerfile: Dockerfile
    container_name: fintechops-admin-service
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3009
      - MONGODB_URI=mongodb://admin:password123@mongodb:27017/fintechops?authSource=admin
      - POSTGRES_URI=postgres://fintechops:password123@postgres:5432/fintechops
    ports:
      - "3009:3009"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - fintechops-network

  # ============================================
  # FRONTEND
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: fintechops-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - api-gateway
    networks:
      - fintechops-network

# ============================================
# NETWORKS
# ============================================
networks:
  fintechops-network:
    driver: bridge

# ============================================
# VOLUMES
# ============================================
volumes:
  mongodb_data:
  postgres_data:
  redis_data:
